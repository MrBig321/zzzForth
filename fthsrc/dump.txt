: HEXDUMP ;  ( marker for FORGET)

DECIMAL 

10000 CONSTANT LIMITLEN
12 CONSTANT BYTESPERROW 

VARIABLE LASTCNT

: KEY? KEYW DISCARD DROP ;

: DIGS2  ( b -- )
   DUP 4 RSHIFT 0= IF 48 EMIT THEN U. ; 

: PRINTABLE? ( c -- flag )
   DUP 32 >= SWAP 127 < AND ;

: PRINTCHS  ( addr len -- )
   0 DO DUP C@ DUP PRINTABLE? IF EMIT ELSE DROP 46 EMIT THEN 1+ LOOP DROP ;

: PRINTADDR  ( addr -- )
   32 7 0 DO 4 - 2DUP RSHIFT 0= IF 48 EMIT ELSE LEAVE THEN LOOP DROP U. SPACE ;

: FILLLASTCNT  ( -- )
    DUP BYTESPERROW MOD DUP 0<> IF LASTCNT ! ELSE DROP 0 LASTCNT ! THEN ;

: PRINTLN  ( cnt -- )
    BYTESPERROW MOD 0= AND IF SWAP SPACE BYTESPERROW PRINTCHS DUP CR DUP PRINTADDR THEN DUP C@ DIGS2 1+ ; 

: PRINTLAST  ( addr len -- )
    LASTCNT @ DUP 0= IF DROP SPACE BYTESPERROW PRINTCHS ELSE DUP BYTESPERROW SWAP - 3 * 1+ SPACES PRINTCHS THEN ;

: HDUMP  ( addr len -- )
   HEX DUP 0= OVER LIMITLEN U> OR IF 2DROP EXIT THEN 
   FILLLASTCNT CR OVER SWAP    ( addr addr len )
   0 DO
    I 0= IF DUP PRINTADDR THEN 
    I 0 <> I PRINTLN PAUSE 
   LOOP DROP PRINTLAST CR ;


